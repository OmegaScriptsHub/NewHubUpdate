local SF = {}

-- Utility function to get the closest player to the cursor
SF.ClosestPlayerToCurser = function()
    local MaxDistance, Closest = math.huge
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= Player and v.Character then
            local H = v.Character:FindFirstChild("Head")
            if H then
                local Pos, Vis = Workspace.CurrentCamera:WorldToScreenPoint(H.Position)
                if Vis then
                    local A1, A2 = Vector2.new(Mouse.X, Mouse.Y), Vector2.new(Pos.X, Pos.Y)
                    local Dist = (A2 - A1).Magnitude
                    if Dist < MaxDistance and Dist <= math.huge then
                        MaxDistance = Dist
                        Closest = v
                    end
                end
            end
        end
    end
    return Closest
end

-- Hit function to attack mobs
SF.Hit = function(Mob)
    BladeCombatRemote:FireServer(false, Vector3.new(Mob.HumanoidRootPart.Position), CFrame.new(Mob.HumanoidRootPart.Position))
end

-- Function to instantly kill a mob
SF.InstantKill = function(v)
    if v.Humanoid.Health <= v.Humanoid.MaxHealth then
        v.Humanoid.Health = 0
    end
end

-- Function to get the weapon
SF.GetWeapon = function()
    for _, v in ipairs(Player.Backpack:GetChildren()) do
        if v:IsA("Tool") and v:FindFirstChild("Combat Script") then
            VG.GetHumanoid():EquipTool(v)
        end
    end
end

-- Function to kill a specific mob
SF.KillMob = function(MobName)
    for _, v in ipairs(Workspace.Live:GetChildren()) do
        if v.Name == MobName and v:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
            VG.Teleport(v.HumanoidRootPart.Position + Vector3.new(0, -6, 3))
            SF.Hit(v)
            local Tool = Player.Character:FindFirstChildWhichIsA("Tool")
            if Tool and not Tool:FindFirstChild("Combat Script") then
                SF.GetWeapon()
            elseif not Tool then
                SF.GetWeapon()
            end
            SF.InstantKill(v)
        end
    end
end

-- Function to kill a boss
SF.KillBoss = function()
    for _, v in ipairs(Workspace.Live:GetChildren()) do
        if table.find(Bosses, v.Name) and v:FindFirstChild("HumanoidRootPart") then
            if v:FindFirstChild("Humanoid") and v.Humanoid.Health ~= 0 then
                VG.Teleport(v.HumanoidRootPart.Position + Vector3.new(0,-5,0))
                local Tool = Player.Character:FindFirstChildWhichIsA("Tool")
                if not Tool and Tool:FindFirstChild("Combat Script") then
                    SF.GetWeapon()
                end
                SF.Hit(v)
            end
        end
    end
end

-- Function to get a quest
SF.GetQuest = function(Quest)
    if not Player.PlayerGui.Menu.QuestFrame.Visible then
        RemoteEvents:WaitForChild("ChangeQuestRemote"):FireServer(ReplicatedStorage:WaitForChild("Quests"):FindFirstChild(Quest))
    end
end

-- Function to buy a selected item
SF.BuySelectedItem = function(Item)
    BuyItemRemote:FireServer(tostring(Item))
end

-- Function to get a lucky arrow
SF.GetLuckyArrow = function()
    if #Player.Backpack:GetChildren() >= 10 then
        for _, v in ipairs(Player.Backpack:GetChildren()) do
            if v.Name ~= "Arrow" and table.find(Arrows, v.Name) then
                v.Parent = Player.Character
                for i = 1, 13 do
                    for _, val in ipairs(Player.PlayerValues:GetChildren()) do
                        if val.Name:match("ItemStorage" .. i) and val.Value == "" then wait(0.001)
                            ReplicatedStorage.RemoteEvents.ItemStorageRemote:FireServer(val.Name)
                        end
                    end
                end
                wait(3)
            elseif not table.find(Arrows, v.Name) and v.Name ~= "Arrow" then
                InvCleaner:FireServer()
                break
            end
        end
    else
        SF.BuySelectedItem("Arrow")
    end
end

-- Function to get the selected armor
SF.GetSelectedArmor = function(Rarity)
    if #Player.Backpack:GetChildren() >= 10 then
        for _, v in ipairs(Player.Backpack:GetChildren()) do
            if v.Name == "Bag" and v:FindFirstChild("BagPart") then
                local New = v.BagPart:FindFirstChild("Rarity", true)
                if New.Text == Rarity then
                    v.Parent = Player.Character
                    wait(3)
                end
            elseif New.Text ~= Rarity then
                InvCleaner:FireServer()
                break
            end
        end
    else
        SF.BuySelectedItem("Random Armor")
    end
end

local LegitHit = function()
    VG.User:SendMouseButtonEvent(0,0, 1, false, game, -1)
end

-- Function to roll a race
SF.RollRace = function()
    if Player.PlayerValues.Race.Value ~= WantedRace then
        if not Player.Character:FindFirstChild("Heart") or not Player.Backpack:FindFirstChild("Heart") then
            SF.BuySelectedItem("Heart")
        end
        if Player.Backpack:FindFirstChild("Heart") then
            Player.Backpack:FindFirstChild("Heart").Parent = Player.Character
            RemoteEvents:WaitForChild("ItemRemote"):FireServer()
        end
    end
end

-- Function to roll a trait
SF.RollTrait = function()
    if Player.PlayerValues.Trait.Value ~= WantedTrait then
        if not Player.Character:FindFirstChild("Eyeball") or not Player.Backpack:FindFirstChild("Eyeball") then
            SF.BuySelectedItem("Eyeball")
        end
        if Player.Backpack:FindFirstChild("Eyeball") then
            Player.Backpack:FindFirstChild("Eyeball").Parent = Player.Character
            RemoteEvents:WaitForChild("ItemRemote"):FireServer()
        end
    end
end

-- Function to roll a class
SF.RollClass = function()
    if Player.PlayerValues.Class.Value ~= WantedClass then
        if not Player.Character:FindFirstChild("Brain") or not Player.Backpack:FindFirstChild("Brain") then
            SF.BuySelectedItem("Brain")
        end
        if Player.Backpack:FindFirstChild("Brain") then
            Player.Backpack:FindFirstChild("Brain").Parent = Player.Character
            RemoteEvents:WaitForChild("ItemRemote"):FireServer()
        end
    end
end

-- Function for auto questing
SF.AutoQuest = function()
    SF.GetQuest(WantedQuest)
    for _, v in ipairs(Workspace.Live:GetChildren()) do
        if v:IsA("Model") and v:FindFirstChild("Quest") and v.Quest.Value == WantedQuest then
            if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                if v:FindFirstChild("HumanoidRootPart") then
                    if Method == "Under Mob" then
                        VG.Teleport(v.HumanoidRootPart.Position + Vector3.new(0, -6, 3))
                        SF.Hit(v)
                        SF.InstantKill(v)
                    elseif Method == "Below Map" then
                        VG.Teleport(v.HumanoidRootPart.Position + Vector3.new(0, -6, 3))
                        if VG.isnetworkowner(v) then
                            v.HumanoidRootPart.CFrame = QuesMarks[WantedQuest].Position + Vector3.new(0,-50,0)
                            VG.Teleport(QuesMarks[WantedQuest].Position + Vector3.new(0,-50,0))
                            SF.Hit(v)
                            SF.InstantKill(v)
                        end
                    end
                end
            end
        end
    end
end

-- Function to kill selected boss
SF.KillSelectedBoss = function()
    for i,v in next, Live:GetChildren() do
        if v.Name == WantedBoss and v:FindFirstChild("HumanoidRootPart") then
            VG.Teleport(v.HumanoidRootPart.Position + Vector3.new(0, -6, 3))
            for i,v in next,Keys do VG.KeyPress(true,"E",false,game,0) wait(.1) end
            LegitHit()
        end
    end
end

return SF
